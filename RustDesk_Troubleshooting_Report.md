# RustDesk 搭建与排障复盘报告

## 🎯 成功要素总结

本次成功解决 Mac 上 RustDesk 自建服务连接问题的核心，在于解决了 **“网络环境复杂性”** 与 **“鉴权一致性”** 的双重冲突。

### ✅ 关键生效设置（必选项）
1.  **VPN 直连规则 (最为关键)**
    *   **现象**: 在 M4 Mac 上开启 VPN/代理软件时，本地对 `nas.suang.site` 的 DNS 解析被劫持到了虚假 IP (`198.18.x.x`)。
    *   **后果**: Mac 客户端虽然填了本机 IP 或域名，但在与 Docker 容器通信的复杂链路中，鉴权包的来源地址与服务器预期的不一致，导致 Key 验证失败。
    *   **解决**: 在 VPN 中添加 **DOMAIN-SUFFIX** `nas.suang.site` -> **DIRECT**。这确保了 Mac 访问此域名时解析出真实公网 IP 或正确回环，不再被 VPN 接管。

2.  **Mac 端显式指定域名中继**
    *   **现象**: Mac 端如果 Relay Server 填 `127.0.0.1`，可能会导致服务器在通过公网告知 iPhone “去哪里找数据流”时发生地址混淆。
    *   **解决**: 将 Mac 端的 Relay Server 统一修改为公网域名 `nas.suang.site`。配合 VPN直连规则，既保证了 Mac 能连上，也保证了它上报给服务器的地址信息是通用的。

3.  **强制重置 Key (鉴权一致性)**
    *   **现象**: 在多次修改配置（加密/非加密、更换容器）过程中，客户端（尤其是 iPhone）极易缓存旧 Key，导致报错误导（报 Invalid Key 其实是网络或缓存问题）。
    *   **解决**: 彻底删除 Docker 卷数据，生成全新 Key，并强制两端重新填入。这是排除干扰的终极手段。

### ⚪ 非关键因素（可选项/误导项）
*   **Docker 的端口映射方式**: 我们使用的是标准的 `-p` 映射。虽然 Mac Docker 网络复杂，但只要端口通了，这不是本次的核心瓶颈。
*   **API Server**: 无需填写。对于简单的 Key 验证模式，填了反而增加复杂度。
*   **服务器配置 `ENCRYPTED_ONLY=0`**: 事实证明，即使设为允许空 Key，只要网络层有干扰（DNS劫持），连接依然会断。所以**安全策略不是锅，网络通路才是**。

---

## 💡 经验与教训

### 1. 代理软件是把双刃剑
在开发或自建服务时，如果本机运行了 Surge/Clash 等代理软件，**永远第一步先检查 DNS 解析**。
*   命令 `host 你的域名` 如果返回 `198.18.x.x`，说明流量被劫持了。
*   对于自建服务，务必第一时间配置 **直连规则 (Direct)**。

### 2. 客户端报错不可全信
RustDesk 报错 "Invalid Key" 时，不一定是 Key 填错了。
*   **真相**: 可能是网络包再经过 NAT 或 VPN 转发时，源地址变了，或者是数据包完整性受损，服务器处于安全考虑拒绝了连接，客户端只能报 Key 错误。

### 3. 环境一致性优于“巧劲”
试图在 Mac 端用 `127.0.0.1` (为了快)而在手机端用域名(为了通)，这种“混合配置”在双重 NAT + Docker 的复杂网络下极易翻车。
*   **最佳实践**: 内外网统一使用域名，通过路由器回环 (NAT Loopback) 或 VPN 直连规则来处理内网访问。让所有设备“看到的”世界是一样的。

---

## 📋 最终配置备忘

### 服务器 (Mac Docker)
*   **Ports**: 21115-21119 (TCP/UDP)
*   **Env**: `RELAY=nas.suang.site:21117`, `ENCRYPTED_ONLY=1`

### 客户端 (iPhone & Mac)
*   **ID Server**: `nas.suang.site`
*   **Relay Server**: `nas.suang.site`
*   **Key**: `k+1Sl9xRBLjQzbcxzN+NOKTLXm2birMFrEKWeCiCT4U=`
*   **Mac 特殊配置**: VPN 软件中添加 `nas.suang.site` 为直连。
